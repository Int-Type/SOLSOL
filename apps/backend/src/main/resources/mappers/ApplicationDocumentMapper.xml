<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.ApplicationDocumentMapper">

    <!-- Result Map for ApplicationDocument -->
    <resultMap id="ApplicationDocumentResultMap" type="com.solsol.heycalendar.entity.ApplicationDocument">
        <id property="applicationDocumentNm" column="applicationDocumentNm" />
        <result property="userNm" column="userNm" />
        <result property="scholarshipNm" column="scholarshipNm" />
        <result property="objectKeyEnc" column="object_key_enc" />
        <result property="fileNameEnc" column="file_name_enc" />
        <result property="contentType" column="content_type" />
        <result property="fileSize" column="file_size" />
        <result property="checksumSha256" column="checksum_sha256" />
        <result property="uploadedAt" column="uploaded_at" />
    </resultMap>

    <!-- Result Map for ApplicationDocumentResponse -->
    <resultMap id="ApplicationDocumentResponseResultMap" type="com.solsol.heycalendar.dto.response.ApplicationDocumentResponse">
        <id property="applicationDocumentNm" column="applicationDocumentNm" />
        <result property="userNm" column="userNm" />
        <result property="scholarshipNm" column="scholarshipNm" />
        <result property="fileUrl" column="object_key_enc" />
        <result property="uploadedAt" column="uploaded_at" />
        <result property="originalFileName" column="file_name_enc" />
        <result property="fileSize" column="file_size" />
        <result property="contentType" column="content_type" />
        <result property="formattedFileSize" column="formatted_file_size" />
    </resultMap>

    <!-- Find all documents -->
    <select id="findAllDocuments" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        ORDER BY uploaded_at DESC
    </select>

    <!-- Find documents by user and scholarship -->
    <select id="findDocumentsByUserAndScholarship" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
        ORDER BY uploaded_at DESC
    </select>

    <!-- Find documents by application (for admin) -->
    <select id="findDocumentsByApplication" resultMap="ApplicationDocumentResponseResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, 
               object_key_enc,
               uploaded_at, 
               file_name_enc, 
               file_size, content_type,
               CASE 
                   WHEN file_size &lt; 1024 THEN CONCAT(file_size, ' B')
                   WHEN file_size &lt; 1048576 THEN CONCAT(ROUND(file_size/1024, 1), ' KB')
                   ELSE CONCAT(ROUND(file_size/1048576, 1), ' MB')
               END as formatted_file_size
        FROM applicationdocument
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
        ORDER BY uploaded_at DESC
    </select>

    <!-- Find document by name and application -->
    <select id="findDocumentByNameAndApplication" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE applicationDocumentNm = #{documentNm} 
              AND userNm = #{userNm} 
              AND scholarshipNm = #{scholarshipNm}
    </select>

    <!-- Find document by document name only -->
    <select id="findDocumentByName" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE applicationDocumentNm = #{documentNm}
    </select>

    <!-- Find documents by user -->
    <select id="findDocumentsByUser" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE userNm = #{userNm}
        ORDER BY uploaded_at DESC
    </select>

    <!-- Find documents by scholarship -->
    <select id="findDocumentsByScholarship" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE scholarshipNm = #{scholarshipNm}
        ORDER BY uploaded_at DESC
    </select>

    <!-- Insert a new document -->
    <insert id="insertDocument" parameterType="com.solsol.heycalendar.entity.ApplicationDocument">
        INSERT INTO applicationdocument (
            applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
            content_type, file_size, checksum_sha256, uploaded_at
        )
        VALUES (
            #{applicationDocumentNm}, #{userNm}, #{scholarshipNm}, #{objectKeyEnc}, #{fileNameEnc},
            #{contentType}, #{fileSize}, #{checksumSha256}, #{uploadedAt}
        )
    </insert>

    <insert id="insertApplicationDocument" parameterType="com.solsol.heycalendar.entity.ApplicationDocument"
            useGeneratedKeys="true" keyProperty="applicationDocumentNm">
        INSERT INTO applicationdocument (
            applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
            content_type, file_size, checksum_sha256, uploaded_at
        )
        VALUES (
            #{applicationDocumentNm}, #{userNm}, #{scholarshipNm}, #{objectKeyEnc}, #{fileNameEnc},
            #{contentType}, #{fileSize}, #{checksumSha256}, #{uploadedAt}
        )
    </insert>

    <!-- Update an existing document -->
    <update id="updateDocument" parameterType="com.solsol.heycalendar.entity.ApplicationDocument">
        UPDATE applicationdocument
        SET object_key_enc = #{objectKeyEnc},
            file_name_enc = #{fileNameEnc},
            file_size = #{fileSize},
            content_type = #{contentType},
            checksum_sha256 = #{checksumSha256}
        WHERE applicationDocumentNm = #{applicationDocumentNm}
              AND userNm = #{userNm}
              AND scholarshipNm = #{scholarshipNm}
    </update>

    <!-- Delete a document by name and application -->
    <delete id="deleteDocument">
        DELETE FROM applicationdocument
        WHERE applicationDocumentNm = #{documentNm}
              AND userNm = #{userNm}
              AND scholarshipNm = #{scholarshipNm}
    </delete>

    <!-- Delete all documents for an application -->
    <delete id="deleteDocumentsByApplication">
        DELETE FROM applicationdocument
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </delete>

    <!-- Count documents by user and scholarship -->
    <select id="countDocumentsByUserAndScholarship" resultType="int">
        SELECT COUNT(*)
        FROM applicationdocument
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </select>

    <!-- Count documents by user -->
    <select id="countDocumentsByUser" resultType="int">
        SELECT COUNT(*)
        FROM applicationdocument
        WHERE userNm = #{userNm}
    </select>

    <!-- Count documents by scholarship -->
    <select id="countDocumentsByScholarship" resultType="int">
        SELECT COUNT(*)
        FROM applicationdocument
        WHERE scholarshipNm = #{scholarshipNm}
    </select>

    <!-- Count total documents -->
    <select id="countTotalDocuments" resultType="int">
        SELECT COUNT(*)
        FROM applicationdocument
    </select>

    <!-- Find documents by content type -->
    <select id="findDocumentsByContentType" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE content_type = #{contentType}
        ORDER BY uploaded_at DESC
    </select>

    <!-- Find documents larger than specified size -->
    <select id="findDocumentsLargerThan" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE file_size > #{fileSize}
        ORDER BY file_size DESC
    </select>

    <!-- Find documents uploaded within date range -->
    <select id="findDocumentsByDateRange" resultMap="ApplicationDocumentResultMap">
        SELECT applicationDocumentNm, userNm, scholarshipNm, object_key_enc, file_name_enc,
               content_type, file_size, checksum_sha256, uploaded_at
        FROM applicationdocument
        WHERE DATE(uploaded_at) BETWEEN #{startDate} AND #{endDate}
        ORDER BY uploaded_at DESC
    </select>

</mapper>

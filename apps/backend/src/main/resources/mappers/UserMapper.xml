<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.UserMapper">

    <!-- 공통 컬럼 리스트 -->
    <sql id="User_Columns">
        `userNm`,
        `userMileage`,
        `accountNm`,
        `userId`,
        `password`,
        `userKey`,
        `userName`,
        `state`,
        `grade`,
        `gpa`,
        `createdAt`,
        `updatedAt`,
        UPPER(`role`) AS `role`,
        `deptNm`,
        `collegeNm`,
        `univNm`
    </sql>

    <!-- ResultMap: ENUM과 LocalDateTime 자동 매핑(기본 TypeHandler 사용) -->
    <resultMap id="UserResultMap" type="com.solsol.heycalendar.domain.User">
        <id     property="userNm"      column="userNm"/>
        <result property="userMileage" column="userMileage"/>
        <result property="accountNm"   column="accountNm"/>
        <result property="userId"      column="userId"/>
        <result property="password"    column="password"/>
        <result property="userKey"     column="userKey"/>
        <result property="userName"    column="userName"/>
        <result property="state"      column="state"    javaType="com.solsol.heycalendar.domain.State"/>
        <result property="grade"       column="grade"/>
        <result property="gpa"         column="gpa"      javaType="java.math.BigDecimal"/>
        <result property="createdAt"   column="createdAt" javaType="java.time.LocalDateTime"/>
        <result property="updatedAt"   column="updatedAt" javaType="java.time.LocalDateTime"/>
        <result property="role"        column="role"     javaType="com.solsol.heycalendar.domain.Role"/>
        <result property="deptNm"      column="deptNm"/>
        <result property="collegeNm"   column="collegeNm"/>
        <result property="univNm"      column="univNm"/>
    </resultMap>

    <!-- userId로 단건 조회 -->
    <select id="findByUserId" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userId` = #{userId}
        LIMIT 1
    </select>

    <!-- userNm(학번)로 단건 조회 -->
    <select id="findByUserNm" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userNm` = #{userNm}
        LIMIT 1
    </select>

    <!-- 비밀번호 해시 수정 -->
    <update id="updatePasswordByUserId">
        UPDATE `users`
        SET
            `password` = #{encodedPassword},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- 비밀번호 재설정용 코드 저장 -->
    <update id="updateUserKeyByUserId">
        UPDATE `users`
        SET
            `userKey` = #{userKey},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- 비밀번호 재설정 완료 후 코드 제거 -->
    <update id="clearUserKeyByUserId">
        UPDATE `users`
        SET
            `userKey` = NULL,
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- 🔹 userKey로 단건 조회 -->
    <select id="findByUserKey" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userKey` = #{userKey}
        LIMIT 1
    </select>

    <!-- 🔹 userKey로 토큰 제거 -->
    <update id="clearUserKeyByUserKey">
        UPDATE `users`
        SET
            `userKey` = NULL,
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userKey` = #{userKey}
    </update>

    <!-- 🔹 신한은행 유저키와 계좌번호 저장 -->
    <update id="updateUserKeyAndAccountByUserId">
        UPDATE `users`
        SET
            `userKey` = #{userKey},
            `accountNm` = #{accountNm},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- 🔹 사용자 정보 수정 -->
    <update id="updateUserInfo">
        UPDATE `users`
        SET
            `updatedAt` = CURRENT_TIMESTAMP
            <if test="request.userName != null and request.userName != ''">
                , `userName` = #{request.userName}
            </if>
            <if test="request.deptNm != null">
                , `deptNm` = #{request.deptNm}
            </if>
            <if test="request.collegeNm != null">
                , `collegeNm` = #{request.collegeNm}
            </if>
            <if test="request.univNm != null">
                , `univNm` = #{request.univNm}
            </if>
            <if test="request.grade != null">
                , `grade` = #{request.grade}
            </if>
        WHERE `userId` = #{userId}
    </update>

    <!-- 🔹 회원가입 시 사용자 등록 -->
    <insert id="insertUser" parameterType="com.solsol.heycalendar.domain.User">
        INSERT INTO `users` (
            `userNm`,
            `userId`,
            `password`,
            `userName`,
            `state`,
            `grade`,
            `deptNm`,
            `collegeNm`,
            `univNm`,
            `role`,
            `createdAt`,
            `updatedAt`
        ) VALUES (
            #{userNm},
            #{userId},
            #{password},
            #{userName},
            #{state},
            #{grade},
            #{deptNm},
            #{collegeNm},
            #{univNm},
            #{role},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 활성 사용자의 userNm 목록 조회 (알림용) -->
    <select id="findAllActiveUserNames" resultType="string">
        SELECT userNm 
        FROM `users`
        WHERE state = 'ENROLLED'
    </select>

    <!-- 마일리지 절대값으로 업데이트 -->
    <update id="updateUserMileage">
        UPDATE `users`
        SET 
            `userMileage` = #{mileageAmount},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userNm` = #{userNm}
    </update>

    <!-- 마일리지 추가 (기존 값에 더하기) -->
    <update id="addUserMileage">
        UPDATE `users`
        SET 
            `userMileage` = COALESCE(`userMileage`, 0) + #{mileageAmount},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userNm` = #{userNm}
    </update>

</mapper>

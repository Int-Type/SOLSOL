<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.ExchangeMapper">

    <!-- Result map for Exchange entity -->
    <resultMap id="ExchangeResultMap" type="com.solsol.heycalendar.domain.Exchange">
        <id property="exchangeNm" column="exchange_nm"/>
        <result property="userNm" column="user_nm"/>
        <result property="amount" column="amount"/>
        <result property="state" column="state" 
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="appliedAt" column="applied_at"/>
        <result property="processedAt" column="processed_at"/>
        <result property="reason" column="reason"/>
    </resultMap>

    <!-- Insert new exchange record -->
    <insert id="insert" parameterType="com.solsol.heycalendar.domain.Exchange">
        INSERT INTO exchange (
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        ) VALUES (
            #{exchangeNm},
            #{userNm},
            #{amount},
            #{state,typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            #{appliedAt},
            #{processedAt},
            #{reason}
        )
    </insert>

    <!-- Update exchange record -->
    <update id="update" parameterType="com.solsol.heycalendar.domain.Exchange">
        UPDATE exchange SET
            user_nm = #{userNm},
            amount = #{amount},
            state = #{state,typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            applied_at = #{appliedAt},
            processed_at = #{processedAt},
            reason = #{reason}
        WHERE exchange_nm = #{exchangeNm}
    </update>

    <!-- Find exchange record by primary key -->
    <select id="findById" resultMap="ExchangeResultMap">
        SELECT 
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        FROM exchange
        WHERE exchange_nm = #{exchangeNm}
    </select>

    <!-- Find exchange records by user name -->
    <select id="findByUserNm" resultMap="ExchangeResultMap">
        SELECT 
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        FROM exchange
        WHERE user_nm = #{userNm}
        ORDER BY applied_at DESC
    </select>

    <!-- Find all exchange records -->
    <select id="findAll" resultMap="ExchangeResultMap">
        SELECT 
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        FROM exchange
        ORDER BY applied_at DESC
    </select>

    <!-- Find exchange records by state -->
    <select id="findByState" resultMap="ExchangeResultMap">
        SELECT 
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        FROM exchange
        WHERE state = #{state,typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        ORDER BY applied_at DESC
    </select>

    <!-- Find exchange records by user name and state -->
    <select id="findByUserNmAndState" resultMap="ExchangeResultMap">
        SELECT 
            exchange_nm,
            user_nm,
            amount,
            state,
            applied_at,
            processed_at,
            reason
        FROM exchange
        WHERE user_nm = #{userNm}
          AND state = #{state,typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        ORDER BY applied_at DESC
    </select>

    <!-- Calculate total exchange amount by user name and state -->
    <select id="calculateTotalByUserNmAndState" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(amount), 0)
        FROM exchange
        WHERE user_nm = #{userNm}
          AND state = #{state,typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    </select>

</mapper>
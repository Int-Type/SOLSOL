<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.MileageMapper">

    <!-- Result map for Mileage entity -->
    <resultMap id="MileageResultMap" type="com.solsol.heycalendar.domain.Mileage">
        <id property="key" column="key"/>
        <result property="userNm" column="userNm"/>
        <result property="amount" column="amount"/>
        <result property="scholarshipNm" column="scholarshipNm"/>
        <result property="createdAt" column="created_at"/>
        <result property="reason" column="reason"/>
    </resultMap>

    <!-- Insert new mileage record -->
    <insert id="insert" parameterType="com.solsol.heycalendar.domain.Mileage" 
            useGeneratedKeys="true" keyProperty="key">
        INSERT INTO mileage (
            userNm,
            amount,
            scholarshipNm,
            reason
        ) VALUES (
            #{userNm},
            #{amount},
            #{scholarshipNm},
            #{reason}
        )
    </insert>

    <!-- Find mileage records by user name -->
    <select id="findByUserNm" resultMap="MileageResultMap">
        SELECT 
            `key`,
            userNm,
            amount,
            scholarshipNm,
            created_at,
            reason
        FROM mileage
        WHERE userNm = #{userNm}
        ORDER BY `key` DESC
    </select>

    <!-- Find mileage record by primary key -->
    <select id="findById" resultMap="MileageResultMap">
        SELECT 
            `key`,
            userNm,
            amount,
            scholarshipNm,
            created_at,
            reason
        FROM mileage
        WHERE `key` = #{key}
    </select>

    <!-- Find all mileage records -->
    <select id="findAll" resultMap="MileageResultMap">
        SELECT 
            `key`,
            userNm,
            amount,
            scholarshipNm,
            created_at,
            reason
        FROM mileage
        ORDER BY `key` DESC
    </select>

    <!-- Calculate total mileage for a user -->
    <select id="calculateTotalByUserNm" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(amount), 0)
        FROM mileage
        WHERE userNm = #{userNm}
    </select>

    <!-- Find mileage record by user and scholarship -->
    <select id="findByUserNmAndScholarshipNm" resultMap="MileageResultMap">
        SELECT 
            `key`,
            userNm,
            amount,
            scholarshipNm,
            created_at,
            reason
        FROM mileage
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- Check if mileage exists for user and scholarship -->
    <select id="existsByUserNmAndScholarshipNm" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM mileage
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </select>

</mapper>
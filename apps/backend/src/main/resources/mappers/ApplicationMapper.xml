<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.ApplicationMapper">

    <!-- Result Map for Application -->
    <resultMap id="ApplicationResultMap" type="com.solsol.heycalendar.entity.Application">
        <id property="userNm" column="userNm" />
        <id property="scholarshipNm" column="scholarshipNm" />
        <result property="state" column="state" typeHandler="com.solsol.heycalendar.config.ApplicationStateTypeHandler" />
        <result property="appliedAt" column="applied_at" />
        <result property="reason" column="reason" />
    </resultMap>

    <!-- Result Map for ApplicationResponse with Scholarship Info -->
    <resultMap id="ApplicationResponseResultMap" type="com.solsol.heycalendar.dto.response.ApplicationResponse">
        <result property="userNm" column="userNm"/>
        <result property="scholarshipNm" column="scholarshipNm"/>
        <result property="scholarshipName" column="scholarship_name"/>
        <result property="scholarshipAmount" column="scholarship_amount"/>
        <result property="scholarshipType" column="scholarship_type"/>
        <result property="scholarshipDescription" column="scholarship_description"/>
        <result property="userName" column="user_name"/>
        <result property="departmentName" column="department_name"/>
        <result property="collegeName" column="college_name"/>
        <result property="universityName" column="university_name"/>
        <result property="state" column="state" typeHandler="com.solsol.heycalendar.config.ApplicationStateTypeHandler"/>
        <result property="appliedAt" column="applied_at"/>
        <result property="reason" column="reason"/>
        <result property="applicationState" column="state" typeHandler="com.solsol.heycalendar.config.ApplicationStateTypeHandler"/>
        <result property="applicationDate" column="applied_at"/>
    </resultMap>

    <!-- Find all applications -->
    <select id="findAllApplications" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        ORDER BY applied_at DESC
    </select>

    <!-- Find applications by user -->
    <select id="findApplicationsByUser" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE userNm = #{userNm}
        ORDER BY applied_at DESC
    </select>

    <!-- Find applications by scholarship -->
    <select id="findApplicationsByScholarship" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE scholarshipNm = #{scholarshipNm}
        ORDER BY applied_at DESC
    </select>

    <!-- Find application by user and scholarship -->
    <select id="findApplicationByUserAndScholarship" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </select>

    <!-- Find application detail with user and scholarship information -->
    <select id="findApplicationDetailByUserAndScholarship" resultMap="ApplicationResponseResultMap">
        SELECT 
            a.userNm, 
            a.scholarshipNm, 
            s.scholarship_name,
            s.amount as scholarship_amount,
            s.type as scholarship_type,
            s.description as scholarship_description,
            u.userName as user_name,
            d.Deptname as department_name,
            c.name as college_name,
            univ.univName as university_name,
            a.state, 
            a.applied_at, 
            a.reason
        FROM application a
        JOIN scholarship s ON a.scholarshipNm = s.id
        LEFT JOIN users u ON a.userNm = u.userNm
        LEFT JOIN department d ON u.deptNm = d.deptNm AND u.collegeNm = d.collegeNm AND u.univNm = d.univNm
        LEFT JOIN college c ON d.collegeNm = c.collegeNm AND d.univNm = c.univNm
        LEFT JOIN university univ ON u.univNm = univ.univNm
        WHERE a.userNm = #{userNm} AND a.scholarshipNm = #{scholarshipNm}
    </select>

    <!-- Insert a new application -->
    <insert id="insertApplication" parameterType="com.solsol.heycalendar.entity.Application">
        INSERT INTO application (userNm, scholarshipNm, state, applied_at, reason)
        VALUES (#{userNm}, #{scholarshipNm}, #{state}, #{appliedAt}, #{reason})
    </insert>

    <!-- Update an existing application -->
    <update id="updateApplication" parameterType="com.solsol.heycalendar.entity.Application">
        UPDATE application
        SET state = #{state},
            reason = #{reason}
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </update>

    <!-- Delete an application -->
    <delete id="deleteApplication">
        DELETE FROM application
        WHERE userNm = #{userNm} AND scholarshipNm = #{scholarshipNm}
    </delete>

    <!-- Count applications by state -->
    <select id="countApplicationsByState" resultType="int">
        SELECT COUNT(*)
        FROM application
        WHERE state = #{state}
    </select>

    <!-- Find applications by state -->
    <select id="findApplicationsByState" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE state = #{state}
        ORDER BY applied_at DESC
    </select>

    <!-- Find applications by user and state -->
    <select id="findApplicationsByUserAndState" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE userNm = #{userNm} AND state = #{state}
        ORDER BY applied_at DESC
    </select>

    <!-- Find applications by scholarship and state -->
    <select id="findApplicationsByScholarshipAndState" resultMap="ApplicationResultMap">
        SELECT userNm, scholarshipNm, state, applied_at, reason
        FROM application
        WHERE scholarshipNm = #{scholarshipNm} AND state = #{state}
        ORDER BY applied_at DESC
    </select>

    <!-- Count total applications -->
    <select id="countTotalApplications" resultType="int">
        SELECT COUNT(*)
        FROM application
    </select>

    <!-- Count applications by user -->
    <select id="countApplicationsByUser" resultType="int">
        SELECT COUNT(*)
        FROM application
        WHERE userNm = #{userNm}
    </select>

    <!-- Count applications by scholarship -->
    <select id="countApplicationsByScholarship" resultType="int">
        SELECT COUNT(*)
        FROM application
        WHERE scholarshipNm = #{scholarshipNm}
    </select>

    <!-- === New queries with scholarship information === -->

    <!-- Find applications by user with scholarship information -->
    <select id="findApplicationsWithScholarshipByUser" resultMap="ApplicationResponseResultMap">
        SELECT 
            a.userNm, 
            a.scholarshipNm, 
            s.scholarship_name,
            u.userName as user_name,
            d.Deptname as department_name,
            c.name as college_name,
            univ.univName as university_name,
            a.state, 
            a.applied_at, 
            a.reason
        FROM application a
        JOIN scholarship s ON a.scholarshipNm = s.id
        LEFT JOIN users u ON a.userNm = u.userNm
        LEFT JOIN department d ON u.deptNm = d.deptNm AND u.collegeNm = d.collegeNm AND u.univNm = d.univNm
        LEFT JOIN college c ON d.collegeNm = c.collegeNm AND d.univNm = c.univNm
        LEFT JOIN university univ ON u.univNm = univ.univNm
        WHERE a.userNm = #{userNm}
        ORDER BY a.applied_at DESC
    </select>

    <!-- Find all applications with scholarship information (Admin) -->
    <select id="findAllApplicationsWithScholarship" resultMap="ApplicationResponseResultMap">
        SELECT 
            a.userNm, 
            a.scholarshipNm, 
            s.scholarship_name,
            s.amount as scholarship_amount,
            s.type as scholarship_type,
            s.description as scholarship_description,
            u.userName as user_name,
            d.Deptname as department_name,
            c.name as college_name,
            univ.univName as university_name,
            a.state, 
            a.applied_at, 
            a.reason
        FROM application a
        JOIN scholarship s ON a.scholarshipNm = s.id
        LEFT JOIN users u ON a.userNm = u.userNm
        LEFT JOIN department d ON u.deptNm = d.deptNm AND u.collegeNm = d.collegeNm AND u.univNm = d.univNm
        LEFT JOIN college c ON d.collegeNm = c.collegeNm AND d.univNm = c.univNm
        LEFT JOIN university univ ON u.univNm = univ.univNm
        ORDER BY a.applied_at DESC
    </select>

    <!-- Find applications by scholarship with user information -->
    <select id="findApplicationsWithUserByScholarship" resultMap="ApplicationResponseResultMap">
        SELECT 
            a.userNm, 
            a.scholarshipNm, 
            s.scholarship_name,
            u.userName as user_name,
            d.Deptname as department_name,
            c.name as college_name,
            univ.univName as university_name,
            a.state, 
            a.applied_at, 
            a.reason
        FROM application a
        JOIN scholarship s ON a.scholarshipNm = s.id
        LEFT JOIN users u ON a.userNm = u.userNm
        LEFT JOIN department d ON u.deptNm = d.deptNm AND u.collegeNm = d.collegeNm AND u.univNm = d.univNm
        LEFT JOIN college c ON d.collegeNm = c.collegeNm AND d.univNm = c.univNm
        LEFT JOIN university univ ON u.univNm = univ.univNm
        WHERE a.scholarshipNm = #{scholarshipNm}
        ORDER BY a.applied_at DESC
    </select>

    <!-- Enum 매핑: DB가 소문자('pending') 저장이면 UPPER로 올려 Java enum(UPPER_CASE)과 매핑 -->
    <resultMap id="ApplicationStatusRowMap" type="com.solsol.heycalendar.dto.response.ApplicationStatusRow">
        <result property="scholarshipId" column="scholarship_id"/>
        <result property="state" column="state"/>
    </resultMap>

    <select id="findStatusesByUserAndScholarshipIds"
            resultMap="ApplicationStatusRowMap">
        SELECT
        a.scholarshipNm                         AS scholarship_id,
        COALESCE(UPPER(a.state), 'NONE')        AS state
        FROM application a
        WHERE a.userNm = #{userNm}
        <if test="ids != null and ids.size() > 0">
            AND a.scholarshipNm IN
            <foreach collection="ids" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </select>

</mapper>
